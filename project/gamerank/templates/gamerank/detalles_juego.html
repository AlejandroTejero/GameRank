{% extends 'gamerank/base.html' %}

{% block contenido %}
<br>
<div class="container mt-5">
    <div class="row">
        <!-- IZQUIERDA: Imagen, datos y bot贸n Volver -->
        <div class="col-md-6">
            <div class="card mb-4 shadow-sm game-info-card">
                <img
                    src="{{ game.thumbnail }}"
                    class="card-img-top game-info-img"
                    alt="{{ game.title }}"
                >
                <div class="card-body">
                    <h2 class="card-title d-flex align-items-center justify-content-between">
                        {{ game.title }}
                        {% if request.user.is_authenticated %}
                            {% if request.user in game.followers.all %}
                                <form action="{% url 'follow_game' game.game_id %}" method="post" class="ms-3">
                                    {% csrf_token %}
                                    <input type="hidden" name="next" value="{{ request.get_full_path }}">
                                    <button type="submit" class="btn btn-secondary btn-sm">Dejar de seguir</button>
                                </form>
                            {% else %}
                                <form action="{% url 'follow_game' game.game_id %}" method="post" class="ms-3">
                                    {% csrf_token %}
                                    <input type="hidden" name="next" value="{{ request.get_full_path }}">
                                    <button type="submit" class="btn btn-primary btn-sm">Seguir</button>
                                </form>
                            {% endif %}
                        {% endif %}
                    </h2>

                    <p class="card-text"><strong>G茅nero:</strong> {{ game.genre }}</p>
                    <p class="card-text"><strong>Fecha de Lanzamiento:</strong> {{ game.release_date }}</p>
                    <p class="card-text"><strong>Plataforma:</strong> {{ game.platform }}</p>
                    <p class="card-text"><strong>Desarrollador:</strong> {{ game.developer }}</p>
                    <p class="card-text"><strong>Publicador:</strong> {{ game.publisher }}</p>
                    <p class="card-text">
                        <strong>Descripci贸n:</strong><br>
                        {{ game.short_description }}
                    </p>

                    <!-- Bot贸n para volver al index -->
                    <a href="{% url 'index' %}" class="btn btn-outline-secondary btn-sm mt-3">Pagina Principal</a>
                    <!-- Bot贸n para descargar json -->
                    <a href="{% url 'descargar_juego_json' game.game_id %}" class="btn btn-outline-success btn-sm mt-3">Descargar JSON</a>
                    <!-- Nuevo bot贸n: lleva a la p谩gina din谩mica de comentarios -->
                    <a href="{% url 'dinamic' game.game_id %}" class="btn btn-outline-info btn-sm mt-3">Ver comentarios din谩micos</a>

                </div>
            </div>
        </div>

        <!-- DERECHA: Valoraciones y comentarios -->
        <div class="col-md-6 d-flex flex-column">
            <!-- Valoraci贸n Media -->
            <div class="mb-4 p-3 bg-light rounded shadow-sm">
                <h5>Valoraci贸n Media</h5>
                <p class="fs-4 mb-1">
                    {{ avg_rating|floatformat:1 }} <small>/ 5</small>
                </p>
                <small class="text-muted">
                    {{ total_ratings }} voto{% if total_ratings != 1 %}s{% endif %}
                </small>
            </div>

            <!-- Tu valoraci贸n -->
            <div class="mb-4 p-3 bg-white rounded shadow-sm">
                <h5>Tu valoraci贸n</h5>
                {% if request.user.is_authenticated %}
                    <form method="post" class="d-flex align-items-center gap-2">
                        {% csrf_token %}
                        {{ rating_form.score }}
                        <button name="submit_rating" class="btn btn-primary btn-sm">
                            Enviar
                        </button>
                    </form>
                    {% if user_rating %}
                        <p class="mt-2 small text-muted">Has puntuado este juego con {{ user_rating }}.</p>
                    {% endif %}
                {% else %}
                    <p><a href="{% url 'login' %}">Inicia sesi贸n</a> para valorar.</p>
                {% endif %}
            </div>


            <!-- Comentarios con like y dislike -->
            <div class="mb-4 p-3 bg-light rounded shadow-sm flex-grow-1 overflow-auto">
              <h5>Comentarios</h5>

              {% if request.user.is_authenticated %}
                {% for c in comments %}
                  <div class="mb-3">
                    <p class="mb-1">
                      <strong>{{ c.user.username }}</strong>
                      <small class="text-muted">{{ c.created_at|date:"d M Y H:i" }}</small>
                      <small class="text-muted"> / Id: {{ c.id }}</small>
                    </p>
                    <p>{{ c.content }}</p>

                    {# Usuario autenticado: puede votar #}
                    <form action="{% url 'voto_comentario' c.id %}" method="post" class="d-inline">
                      {% csrf_token %}
                      <input type="hidden" name="next" value="{{ request.get_full_path }}">
                      <button type="submit" name="action" value="like"
                              class="btn btn-sm
                           {% if c.user_vote == True %}
                             btn-success
                           {% else %}
                             btn-outline-success
                           {% endif %}">
                      <!-- class="btn btn-sm btn-outline-success"> -->
                         {{ c.likes }}
                      </button>
                    </form>

                    <form action="{% url 'voto_comentario' c.id %}" method="post" class="d-inline">
                      {% csrf_token %}
                      <input type="hidden" name="next" value="{{ request.get_full_path }}">
                      <button type="submit" name="action" value="dislike"
                              class="btn btn-sm
                               {% if c.user_vote == False %}
                                 btn-danger
                               {% else %}
                                 btn-outline-danger
                               {% endif %}">
                              <!-- class="btn btn-sm btn-outline-danger"> -->
                         {{ c.dislikes }}
                      </button>
                    </form>
                  </div>
                {% empty %}
                  <p class="text-muted">A煤n no hay comentarios.</p>
                {% endfor %}

              <!-- Esta es la parte que se mostrar谩 si el usuario no esta logueado -->
              {% else %}
                  <p><a href="{% url 'login' %}">Inicia sesi贸n</a> para votar comentarios.</p>
                  {% for c in comments %}
                    <div class="mb-3">
                      <p class="mb-1">
                        <strong>{{ c.user.username }}</strong>
                        <small class="text-muted">{{ c.created_at|date:"d M Y H:i" }}</small>
                      </p>
                      <p>{{ c.content }}</p>

                      {# Botones deshabilitados para likes/dislikes #}
                      <button class="btn btn-sm btn-secondary btn-voto-disabled" disabled title="Inicia sesi贸n para votar">
                         {{ c.likes }}
                      </button>
                      <button class="btn btn-sm btn-secondary btn-voto-disabled" disabled title="Inicia sesi贸n para votar">
                         {{ c.dislikes }}
                      </button>
                    </div>
                  {% empty %}
                    <p class="text-muted">A煤n no hay comentarios.</p>
                  {% endfor %}
                {% endif %}
            </div>

            <!-- Formulario de nuevo comentario -->
            <div class="mb-4 p-3 bg-white rounded shadow-sm">
                {% if request.user.is_authenticated %}
                    <h5>Deja tu comentario</h5>
                    <form method="post">
                        {% csrf_token %}
                        {{ comment_form.content }}
                        <button name="submit_comment" class="btn btn-primary btn-sm mt-2">Enviar comentario</button>
                    </form>
                {% else %}
                    <p><a href="{% url 'login' %}">Inicia sesi贸n</a> para comentar.</p>
                {% endif %}
            </div>

        </div>
    </div>
</div>
<br><br><br>
{% endblock %}

